name: Impacket - Execution, T1047, Lateral Movement, T1021.002, T1021.006 Interactive shell spawned via SMBexec or WMIExec
index_type: events
description: Detects the process wmiprvse.exe responsible for WMI on target host, or services.exe spawning cmd.exe with the following command line, `cmd.exe /Q /c ', ' 1 \\', ' 2 &1`. These strings are specific to the execution of wmiexe.py and smbexec.py part of Impacket, which allows interactive shell.
references: 
    - https://redcanary.com/threat-detection-report/threats/impacket/
	- https://attack.mitre.org/software/S0357/
    - https://attack.mitre.org/techniques/T1047/
	- https://attack.mitre.org/techniques/T1021/006/
tags: execution, t1047, lateral_movement, t1021.002, t1021.006
search_query: (parent_name:wmiprvse.exe OR parent_name:services.exe) AND process_name:cmd.exe AND (cmdline:"/Q" OR cmdline:"echo" OR cmdline:"&1")
on_hit: alert, syslog